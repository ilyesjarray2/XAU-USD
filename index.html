<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEYDRA | OMNI-CHANNEL TERMINAL</title>
    <style>
        :root { --neon: #39FF14; --red: #FF0039; --bg: #050505; --panel: #0a0a0a; --border: #333; }
        body { background: var(--bg); color: #fff; font-family: 'Consolas', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .logo { font-size: 24px; color: var(--neon); letter-spacing: 5px; margin-bottom: 40px; text-shadow: 0 0 10px var(--neon); }
        .menu-item { padding: 15px; cursor: pointer; color: #666; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { color: #fff; background: rgba(57, 255, 20, 0.1); border-left: 3px solid var(--neon); }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-rows: auto 1fr; gap: 20px; }
        
        /* TOP STATS */
        .top-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 5px; }
        .card h3 { margin: 0 0 10px 0; font-size: 12px; color: #888; }
        .card .val { font-size: 20px; font-weight: bold; }

        /* EXECUTION ZONE */
        .exec-zone { border: 2px solid var(--neon); padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 5px; background: rgba(57, 255, 20, 0.02); }
        .btn-scan { background: var(--neon); color: black; border: none; padding: 10px 30px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* DATA TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; color: #888; border-bottom: 1px solid var(--border); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #222; }
        .profit-plus { color: var(--neon); }
        .profit-minus { color: var(--red); }

        /* CUSTOM WIDGET IMG */
        #mfb-widget-img { width: 100%; border-radius: 5px; opacity: 0.8; transition: 0.5s; }
        #mfb-widget-img:hover { opacity: 1; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">NEYDRA</div>
        <div class="menu-item active" onclick="switchTab('dashboard')">DASHBOARD</div>
        <div class="menu-item" onclick="switchTab('trades')">OPEN TRADES</div>
        <div class="menu-item" onclick="switchTab('history')">HISTORY</div>
        <div class="menu-item" onclick="switchTab('sentiment')">SENTIMENT MAP</div>
    </div>

    <div class="main">
        
        <div id="tab-dashboard">
            <div class="top-bar">
                <div class="card">
                    <h3>NET GAIN (30D)</h3>
                    <div class="val" id="val-gain">LOADING...</div>
                </div>
                <div class="card">
                    <h3>XAUUSD SENTIMENT</h3>
                    <div class="val" id="val-sent">LOADING...</div>
                </div>
                <div class="card">
                    <h3>DAILY PROFIT</h3>
                    <div class="val" id="val-daily">LOADING...</div>
                </div>
                <div class="card">
                    <h3>NEYDRA STATUS</h3>
                    <div class="val" style="color:var(--neon)">ONLINE</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="exec-zone">
                    <h2 style="margin-top:0">QUANTITATIVE SCALPING ENGINE</h2>
                    <div id="scan-res" style="font-size: 24px; margin: 20px; min-height: 30px;">READY</div>
                    <button class="btn-scan" onclick="scan()">SCAN MARKET (L2 DOM)</button>
                    <button id="exec-btn" class="btn-scan" style="background:var(--red); color:white; display:none; margin-left:10px;" onclick="exec()">EXECUTE</button>
                </div>

                <div class="card" style="text-align: center;">
                    <h3>LIVE PERFORMANCE WIDGET</h3>
                    <img id="mfb-widget-img" src="" alt="Connecting to Myfxbook...">
                </div>
            </div>
        </div>

        <div id="tab-trades" class="hidden">
            <h2>OPEN POSITIONS</h2>
            <table id="table-trades">
                <thead><tr><th>SYMBOL</th><th>ACTION</th><th>LOTS</th><th>OPEN PRICE</th><th>PROFIT</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-history" class="hidden">
            <h2>TRADE HISTORY</h2>
            <table id="table-history">
                <thead><tr><th>TIME</th><th>SYMBOL</th><th>ACTION</th><th>PROFIT</th><th>COMMENT</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-sentiment" class="hidden">
            <h2>COMMUNITY OUTLOOK BY COUNTRY</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;" id="country-grid">
                </div>
        </div>

    </div>

    <script>
        let currentSignal = {};

        // TAB SWITCHING
        function switchTab(tabName) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-trades').classList.add('hidden');
            document.getElementById('tab-history').classList.add('hidden');
            document.getElementById('tab-sentiment').classList.add('hidden');
            
            document.getElementById('tab-' + tabName).classList.remove('hidden');
        }

        // LOAD DATA ON START
        window.onload = async () => {
            fetchMFBData();
        };

        async function fetchMFBData() {
            try {
                const res = await fetch('http://localhost:8000/mfb-data');
                const data = await res.json();

                // 1. Dashboard Widgets
                document.getElementById('val-gain').innerText = (data.gain_period || 0) + "%";
                if(data.sentiment_global) {
                    document.getElementById('val-sent').innerText = `SHORT: ${data.sentiment_global.shortPercentage}%`;
                }
                
                // Set Widget Image
                if(data.widget_url) {
                    document.getElementById('mfb-widget-img').src = data.widget_url;
                }

                // 2. Open Trades Table
                const tradesBody = document.querySelector('#table-trades tbody');
                tradesBody.innerHTML = "";
                data.open_trades.forEach(t => {
                    const color = t.profit >= 0 ? "profit-plus" : "profit-minus";
                    tradesBody.innerHTML += `<tr><td>${t.symbol}</td><td>${t.action}</td><td>${t.sizing.value}</td><td>${t.openPrice}</td><td class="${color}">${t.profit}</td></tr>`;
                });

                // 3. History Table
                const histBody = document.querySelector('#table-history tbody');
                histBody.innerHTML = "";
                data.history.slice(0, 10).forEach(h => { // Show last 10
                    const color = h.profit >= 0 ? "profit-plus" : "profit-minus";
                    histBody.innerHTML += `<tr><td>${h.closeTime}</td><td>${h.symbol}</td><td>${h.action}</td><td class="${color}">${h.profit}</td><td>${h.comment}</td></tr>`;
                });

                // 4. Sentiment Countries
                const countryGrid = document.getElementById('country-grid');
                countryGrid.innerHTML = "";
                data.sentiment_country.forEach(c => {
                    countryGrid.innerHTML += `<div class="card">
                        <h3>${c.name}</h3>
                        <div>Longs: ${c.longPositions}</div>
                        <div style="color:var(--red)">Shorts: ${c.shortPositions}</div>
                    </div>`;
                });

            } catch(e) { console.log("MFB Load Error", e); }
        }

        // SCALPING FUNCTIONS
        async function scan() {
            document.getElementById('scan-res').innerText = "ANALYZING...";
            const res = await fetch('http://localhost:8000/scan');
            const data = await res.json();
            currentSignal = data;
            
            document.getElementById('scan-res').innerText = `${data.action} | CONF: ${data.confidence}%`;
            document.getElementById('scan-res').style.color = data.action === "BUY" ? "var(--neon)" : (data.action === "SELL" ? "var(--red)" : "white");
            
            if(data.action !== "WAIT") {
                const btn = document.getElementById('exec-btn');
                btn.style.display = "inline-block";
                btn.innerText = `EXEC ${data.action} (${data.lot_size})`;
            }
        }

        async function exec() {
            const url = `http://localhost:8000/execute?action=${currentSignal.action}&lot=${currentSignal.lot_size}`;
            await fetch(url);
            alert("ORDER SENT");
            location.reload();
        }
    </script>
</body>
</html>
